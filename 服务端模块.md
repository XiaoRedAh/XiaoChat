# 服务端架构设计

在设计架构之前，明确这个系统有什么需求目标：
* 系统在服务端要有web页面进行管理通信用户，以及服务端的控制和监控。
* 数据库的对象类，不要被外部污染，要有隔离性
* 使用Netty进行通信，服务端与客户端都会用到通信过程中的协议定义和解析。因此需要抽离出这一层，对外提供Jar包。
* 接口、业务处理、底层服务、通信交互，要有明确的区分和实现，避免造成混乱难以维护

在这之前，我都是用`MVC三层架构`来开发的，它的分层非常清晰，也不复杂，很好上手。但是随着系统功能不断叠加，MVC架构的代码维护越来越难。
* 就拿vo类来说，每次新添业务后，都想直接复用之前写好的vo，于是直接往里面多丢几个属性，久而久之，这个vo越来越庞大，已经看不清最初的样子了，都不知到它来干嘛的，并且被多个业务代码交叉引用，维护很困难。
* model的功能很单一，只提供get/set，并没有跟随业务走，随着开发代码的不断增多，最后难以维护。

于是在这个项目中，我第一次运用到了`DDD四层架构`来开发【当然，业务没有复杂到那个地步，因此属于轻量级的四层架构】
>**应用层{application}**
>对微服务内的领域服务以及微服务外的应用服务进行组合和编排
>对基础层如文件、缓存等数据直接操作形成应用服务，对外提供粗粒度的服务
>领域事件的发布和订阅。通过事件总线和消息队列实现异步数据传输，实现微服务之间的解耦。
>
>**领域层{domain}**
>领域服务位于领域层，为完成领域中跨实体或值对象的操作转换而封装的服务，领域服务以与实体和值对象相同的方式参与实施过程。
>领域服务对同一个实体的一个或多个方法进行组合和封装，或对多个不同实体的操作进行组合或编排，对外暴露成领域服务。
>领域服务封装了核心的业务逻辑。实体自身的行为在实体类内部实现，向上封装成领域服务暴露。
>为隐藏领域层的业务逻辑实现，所有领域方法和服务等均须通过领域服务对外暴露。
>为实现微服务内聚合之间的解耦，原则上禁止跨聚合的领域服务调用和跨聚合的数据相互关联。
>
>**基础层{infrastructrue}**
基础服务位于基础层。为各层提供资源服务（如数据库、缓存等），实现各层的解耦，降低外部资源变化对业务逻辑的影响。
基础服务主要为仓储服务，通过依赖反转的方式为各层提供基础资源服务，领域服务和应用服务调用仓储服务接口，利用仓储实现持久化数据对象或直接访问基础资源。
>
>**接口层{interfaces}**
>接口服务位于用户接口层，用于处理用户发送的Restful请求和解析用户输入的配置文件等，并将信息传递给应用层。

总的来说，设计出：接口层、业务层、领域层、基础层这四个层级，每一个层级负责不同的内容，并且以领域设计为核心。
这个项目中再额外拓展一个通信层，负责Socket服务端对业务流程的处理和数据转发服务，同时将一些数据，聊天记录等进行落库操作。
比如下面这个例子【简单的demo，随着业务的跟进，会有对应的拓展和改变】
```
demo
└── src
    ├── main
    │   ├── java
    │   │   └── org.example
    │   │       ├── application
    │   │       │	├── event
    │   │       │	│   └── ApplicationRunner.java
    │   │       │	└── service
    │   │       │	    └── UserService.java	
    │   │       ├── domain
    │   │       │	├── model
    │   │       │	│   ├── aggregates
    │   │       │	│   │   └── UserRichInfo.java
    │   │       │	│   └── vo
    │   │       │	│       ├── UserInfo.java	
    │   │       │	│       └── UserSchool.java	
    │   │       │	├── repository
    │   │       │	│   └── IuserRepository.java
    │   │       │	└── service
    │   │       │	    └── UserServiceImpl.java	
    │   │       ├── infrastructure
    │   │       │	├── dao
    │   │       │	│   ├── impl
    │   │       │	│   │   └── UserDaoImpl.java
    │   │       │	│   └── UserDao.java	
    │   │       │	├── po
    │   │       │	│   └── UserEntity.java	
    │   │       │	├── repository
    │   │       │	│   ├── mysql
    │   │       │	│   │   └── UserMysqlRepository.java
    │   │       │	│   ├── redis
    │   │       │	│   │   └── UserRedisRepository.java
    │   │       │	│   └── UserRepository.java	
    │   │       │	└── util
    │   │       │	    └── RedisUtil.java
    │   │       ├── interfaces
    │   │       │	├── dto
    │   │       │	│	└── UserInfoDto.java	
    │   │       │	└── facade
    │   │       │		└── DDDController.java
    │   │       └── DDDApplication.java
    │   ├── resources	
    │   │   └── application.yml
    │   └── webapp	
    │       └── WEB-INF
    │        	└── index.jsp	
    └── test
         └── java
             └── org.example.demo.test
                 └── ApiTest.java
```

这里的数据库层、业务层，到最终对外的接口层，所有的对象类都是相互隔离不会造成污染的。
除了添加Socket功能外，没有其他的扩展(如mq，定时任务处理等)，所以比较轻量级的。






